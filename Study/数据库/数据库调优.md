系统调优的最终目标：

- 使应用运行得更快；
- 缩短查询/事务的响应时间；
- 提高事务的整体吞吐量。

# 查询优化

在众多的查询方案中选择出最好效率的执行计划的一种处理过程。查询优化的方法：

- 代数优化：通过对关系代数表达式的等价变换来提高查询效率，代数优化改变查询语句中操作的次序和组合，不涉及底层的存取路径。
- 物理优化：通过选择高校合理的操作算法或存取路径，求得优化的查询计划。
  - 如选择操作典型实现方法有简单的**全表扫描方法**和**索引扫描方法**；
  - 常用的连接操作方法有**嵌套循环方法**、**排序-合并方法**、**索引连接方法**和**Hash Join方法**。

## 嵌套循环连接

选择一个表作为外表，另一个表作为内表。对外表（外层循环）的每一个元组，检索内表（内层循环）中的每一个元组。如果满足连接条件，则串接猴作为结果输出，直到外层循环表中的元组处理完为止。

### 索引嵌套循环连接

如果有一个关系建立了索引，则将建立了索引的关系作为内关系。

## 排序归并连接

如果连接的表没有排好序，先对两张表按连接属性排序。之后的操作与嵌套循环连接类似。

## 索引连接方法

取第一张表中第一个连接属性，根据索引找到第二张表中具有相同连接属性的元组。串接后作为结果输出，直到第一张表中的元组处理完为止。

## 哈希连接

把连接属性作为hash码，用同一个hash函数把两个表中的元组散列到hash表的桶中再进行匹配连接。

## 查询优化方法选择的依据

- 基于规则
- 基于代价：优化器利用关系的统计信息，如数据集的大小、是否存在索引等，对计划做出一个较为准确的估计。

### 执行开销

- 集中式数据库：磁盘存取块数（IO代价）、处理机时间（CPU代价）、查询的内存开销，其中IO代价使最重要的；
- 分布式数据库：IO代价、CPU代价、查询的内存开销、通信代价

### 调优需要的统计信息

存储统计、IO和设备性能统计、查询/事务处理统计、加锁/日志统计、索引统计

# 调优

## 索引的调优

- 判断并建立必要的索引：统计出常用且对性能有影响的语句。重点关注数据库中操作频繁的表，数据流量较大的表、经常需要与其他表进行连接的表等。
- 索引过多会影响到数据库的整体性能，需要一些规则进行约束：
  - 如果一个或一组属性经常在查询条件中出现，则考虑在这个或这组属性上建立索引（或组合索引）。
  - 如果一个属性经常作为最大值和最小值等聚集函数的参数，则考虑在这个属性上建立索引。
  - 如果一个或一组属性经常在连接操作的连接条件中出现，则考虑在这个或这组属性上建立索引。
- 确定所建立的索引是否达到了预期的效果。

### 索引优化的基本原则

1. 将索引和数据存放到不同的文件组；
2. 组合索引的使用；
3. 唯一索引与非唯一索引的差异；
   - 对于不存在重复值的列，创建唯一索引优于创建非唯一索引。
4. 非聚集索引的作用。

## 数据库设计的调优

- 如果由于需要频繁使用两个或多个表中的某些属性，可能需要逆规范化现有的表。

  > 逆规范化是一种通过添加冗余数据的数据库优化技术，可以帮助我们减少关系数据库中耗时的交Join。在一般的规范化的数据库中，我们将数据存在不同的表中是为了减少冗余数据，所以我们会尝试着每条数据在数据库中只有一份。
  >
  > 比如说，在一个规范化的数据库中，我们有Courses表和Teachers表，每个Courses表的一项都会保存teacherID，但是没有teacherName，当我们想要返回Course和teacherName时，我们需要联合两个表。当老师需要改名时，我们只需要修改Teachers表，这是这样做的好处，但是，当表很大的时候，我们联合两表就会很耗时。
  >
  > 逆规范化这里就有用武之地了，我们容忍部分冗余数据和更新表所需多余的一些工作，以此换来快速高效的检索和较少的交操作。很多大公司同时使用规范化和拟规范化数据库。
  >
  > 拟规范的优点：
  >
  > - 检索数据更加快速由于交减少了。
  >
  > - 检索可能更加简单了，因为不用联合多个表。
  >
  > 拟规范的缺点：
  >
  > - 更新和插入操作更费事了。
  >
  > - 更新和插入的脚本更加难写了。
  >
  > - 数据可能不一致了。
  >
  > - 由于存在数据冗余，更占空间了。

- 必要的时候对表进行垂直划分或水平划分；

- 根据应用情况将易变部分与稳定部分、存取频率较高部分与存取频率较低部分，分开存放。

- 如果计算机有多个磁盘或磁盘阵列，可以考虑将表和索引分别放在不同的磁盘上。

- 可以将比较大的表分别放在两个磁盘上，以加快存取速度；

- 尽量使用数字型字段，若只含数值信息的字段，尽量不要设计为字符型。

## 查询的调优

需要进行查询调优的典型情况：

- 查询导致过多的磁盘存取；
- 查询计划表明相关的索引并没有被使用。

### 查询调优原则

- 如果选择条件通过OR连接，可能优化器不会使用任何索引。
- 可以使用下面的转换加快查询：
  - 把NOT条件转化为肯定表达式；
  - 可用连接替换使用IN、=ALL、=ANY、=SOME的嵌入式SELECT块。
  - 如果两个表之间存在等值连接，在一个表中的连接属性上设置的范围谓词可以在另一个表中重复。
  - 可以使用多个列上的索引重写WHERE条件
- 在进行查询时，返回的值应该时查询所需要的，不能过多的使用通配符。
- 对于一些特殊的SQL语句，在使用时应正确选择。
- ……

# Oracle数据库的调优

Oracle使用**CBO（Cost-Based Optimizer，基于成本的优化器）**帮助用户确定执行查询的有效方法。成本时根据花费在检索记录上的IO和CPU时间来定义的，而IO成本时SQL语句执行过程中花费最多的部分。

选择优化的方式：

- 基于规则：根据某些规则从几个备选的访问路径中进行选择。所有的访问路径都被分配了一个排序值，具有最低排序值的路径被选中。
- 基于成本：考虑了数据库对象的最新的统计数据，总是要比老的基于规则的方法执行得要快。

## CBO做些什么

### SQL转换

如果CBO确定另一个SQL表达形式可以更有效地得到同样的结果，在执行该查询之前就会转换该语句。

### 选择访问路径

- 全表扫描

- 通过ROWID对表进行访问

  > ROWID是ORACLE中的一个重要的概念。用于定位数据库中一条记录的一个相对唯一地址值。通常情况下，该值在该行数据插入到数据库表时即被确定且唯一。ROWID它是一个伪列，它并不实际存在于表中。它是ORACLE在读取表中数据行时，根据每一行数据的物理地址信息编码而成的一个伪列。所以根据一行数据的ROWID能找到一行数据的物理地址信息。从而快速地定位到数据行。数据库的大多数操作都是通过ROWID来完成的，而且使用ROWID来进行单记录定位速度是最快的。

- 索引扫描

### 磁盘页面存储结构

磁盘页面中的行布局：

![磁盘页面中的行布局](./photos/row_disk.png)

为了找到一个磁盘页面T中的一行，必需知道：

- 数据对象编号：分配给每个对象的，如表或索引等；
- 数据文件编号：表空间中每个文件的唯一的编号；
- 数据块编号：文件中块的位置；
- 行号：在块头中的行目录的位置；
- ROWID：行指针，具有唯一的编号。

### 选择连接方式

CBO常用的连接方法：嵌套循环连接、散列连接、排序归并连接。

### 选择连接次序

基于可用的索引和访问方法，每一个不同的连接次序都会导致许多不同的执行计划。Optimizer连接的选择总是使得驱动表能够消除最大数目的行的数据。

## 编写有效的SQL

### 有效的WHERE子句

- WHERE子句中的选择性条件可以明显减少Oracle要在一个查询期间考虑到的数据；
- 使用SQL函数
- 使用正确的连接（尽量使用等价连接……）
- 使用CASE语句
- 执行有效的子查询
- 使用WHERE代替HAVING
- 最小化表的查找

### 选择最佳的连接方法

嵌套循环：适用于小的数据子集；

散列连接：适用于连接会产生大的数据子集或表中的很大一部分都要被连接；

合并连接：如果连接中的表是被一个不等式条件所连接，那么最好使用合并连接方式。

### 选择最佳的连接次序

所选择的连接次序应该是可以让最少数目的行参加与其他表的连接。

### 索引的策略

#### 什么时候索引

查询所检索的行数超过表中总的行数10%或15%，可能就不需要索引。如果在一个表中强调行的唯一性，可以对这个表使用主索引。

#### 建立什么索引

对高选择性的列、所有重要的外键、所有谓词列……进行索引

#### 选择合适的索引

B-树、位图、索引组织表……

**位图索引**

位图索引在某些场合比B-tree索引有更大优势：

- 当一张表有上百万条记录而键值的基数很低（列的不同的值很少）时；
- 当经常查询含有or的多个条件的组合查询时；
- 当键值是只读或很少更新时。

位图索引的优点：

- 用于低基数列；
- 适合于多个谓词（含有and、or、not）等多个谓词；
- 需要较少的存储空间，适合于很大的表
- 适合于read-only系统

**索引组织表**

> 索引组织表简称索引表（Index-Organized Table，IOT），是把索引和一般数据列全部存储在相同位置上的表结构，是一个存储在索引结构中的表。它的特点是存储慢，读取快。索引组织表（IOT）不仅可以存储数据，还可以存储为表建立的索引。索引组织表的数据是根据主键排序后的顺序进行排列的，这样就提高了访问的速度，但是，这是由牺牲插入和更新性能为代价的（每次写入和更新后都要重新进行排序）。索引组织表的数据存储在与其关联的索引中。索引中存储的是行的实际数据，而不是ROWID，它是基于主键访问数据的。在索引组织表中，索引就是数据，数据就是索引。

以堆文件相比，IOTs有如下优点：

- 基于索引键的检索较快；
- 减少了存储空间。

**函数索引**

是一种基于表达式的索引。索引表达式可以由列、常量、SQL函数或用户定义函数组成。

### 使用相似的SQL语句

重用已经被分析过的语句还会得到性能上的改进。

### 使用内嵌函数减少SQL开销

### 使用绑定变量

使用绑定变量，变量值在查询执行时提供。这个查询只编译一次，随后会把查询计划存储在一个共享池当中，以便以后获取和重用这个查询计划。

### 避免不合适的视图使用

只要查询一个视图，试图就会在查询的时候被实例化。

### 避免不必要的全表扫描

避免在谓词中使用不等于和大于等于，因为它们可能不使用索引。

## 如何帮助改进SQL处理过程

### 使用分区表

通过将大表和索引分成可以管理的小块，从而避免了对每个表作为一个大的、单独的对象进行管理，分区通过将操作分配给更小的存储单元，减少了需要进行管理操作的时间。通过增强的并行处理提高了性能，且通过屏蔽故障数据的分区，还增加了可用性。

**表可以被分区**：

- 基于值的范围，很大的表可以被减少到扫描小的分区；
- 可以增加和删除分区；
- 优化器可以通过裁减不必要的分区为查询计划找到更有效的访问路径；
- 可以一些分区保持连机状态而另一些分区处于脱机状态。

**Oracle分区优点**：

- 增强可用性；
- 维护方便；
- 均衡IO；
- 改善查询性能。

什么情况下进行分区：

- 数据有千万条；有明显的查询范围或时间段……
- 如果要对一个表进行并行DML操作，必须对它进行分区；
- 为了平衡硬盘IO操作；
- 将表的一部分设置为只读，另一部分设置为可更新的。

### 使用压缩技术

适合于数据仓库和OLAP数据库

### 使用实体化视图

实体化视图储存视图的定义和查询结果。当查询满足视图中数据时，服务器查询视图不查询基表。这样代价较大的连接和聚集函数的运算就不需要重新执行。

### 使用并行处理

## 调整SQL语句的简单步骤

- 识别问题语句
- 定位无效来源
- 调整SQL语句
- 比较性能