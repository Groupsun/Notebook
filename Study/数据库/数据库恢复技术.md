# 一些相关的前导知识

## 故障类型

### 事务失败

- 逻辑错误：一个事务由于其内部错误，导致不能正常结束（如事务内部的死循环）；
- 系统错误：系统进入一个不良状态（如死锁），导致事务无法执行。但该事务在以后的某个时间可以重新执行。

### 系统崩溃

电源问题、其他软硬件引起的系统停机。

### 硬盘故障

可能会导致数据的丢失

## 故障恢复策略

1. 系统故障或事务故障的恢复

   会造成DB不一致状态。恢复方法：

   - 撤销UNDO故障发生时未完成事务对DB的所有影响，确保事务的原子性。
   - 重做REDO已成功提交的已完成事务，实现事务的持久性。
   - 一般由系统在重新启动时自动完成，不需要用户干预。

2. 灾难性或磁盘失败恢复

   使用归档存储设备上的数据库备份进行恢复，并从备份日志重新应用或重做已提交事务的操作来重构故障前数据库的最新状态。

## 数据访问

磁盘和主存间的块移动由下面两个操作引发：

- Input(B)：传送物理块B到主存
- Output(B)：传送缓冲块B到磁盘，并替换磁盘上相应的物理块

当事务第一次需要访问数据项X时，它必须执行read(X)，事务最后一次访问X后，它必须执行write(X)，在数据库中反映X的变化。X所在的缓冲块Bx上的操作output(BX)不需要在write(X)执行后立即执行，因为块Bx可能包含其他仍在被访问的数据项。因此，可能一段时间以后才真正执行输出。

## 磁盘块的高速缓存

- 缓存目录：跟踪哪些数据项在缓冲区中；
- 脏位：每个缓冲区都和一个脏位相关联；
- pin-unpin bit：如果缓冲中的页目前还不能写回到磁盘，则称该页被pin。

## 原位更新和镜像更新

将修改过的缓冲区刷新到磁盘，由两种策略：

- 原位更新：将缓冲区写回磁盘原来的位置，因而会覆盖被修改数据项在磁盘上的旧值。
- 镜像更新：将缓冲区写到磁盘不同的位置，可以保存数据项的多个版本。

数据项更新前的旧值称为前像（BFIM），更新后的新值称为后像（AFIM）。

## WAL规则

WAL，The Write-Ahead Logging Protocol，时一个日志协议规则，明确定义了“先写日志”的思想：

- 先写日志，是保证原子性的关键；
- 在事务提交前将事务相关的所有日志记录写到稳定存储介质，这是保证持久性的关键，确保我们能基于日志重建提交事务。

## 潜入/非潜入和强制/非强制

steal、no-steal和force、no-force确定了何时把数据页从告诉缓存写回到磁盘。

- 如果缓存中被事务更新的某个页在事务提交之前不能写回到磁盘，称为非潜入。反之则为潜入。
- 如果事务所有的已更新的页在事务提交时被立即写回磁盘，称为强制方法。反之则为非强制。

# 基于日志的恢复

基于原位更新的恢复必须使用日志。（灾难性事务故障恢复：基于日志）

## 日志种类

### 种类1

把写操作记录下来：

1. 当事务$T_i$开始时，$T_i$现在日志文件中写入如下的目录：$<T_i \quad start>$

2. 当$T_i$对记录X执行些操作write(X)时，首先写入日志记录$<T_i, X, V_1, V_2>$，其中$V_1$是上述写入操作前X的值，$V_2$是新写入的值。

3. 当$T_i$结束最后一条语句时，写入$<T_i \quad commit>$的日志记录

4. 若事务$T_i$不正常中止，写入$<T_i \quad abort>$

### 种类2

另一种日志形式中，把上述X取为一个物理块，则一个日志记录包含如下三部分：

1. 前像：更新前的映像，可以据此恢复到更新前的状态（撤销更新undo）；
2. 后像：更新后的映像，可以据此恢复到更新后的状态（重做redo）；
3. 事务状态：成功或失败。

# 延迟更新与即时更新

非灾难性事务故障的恢复技术分为延迟更新与即时更新。

- 延迟更新（NO-UNDO/REDO算法）
  - 所有事务的更新都记录在局部事务的工作区（或缓冲区），只有在事务到达提交点后才真正更新磁盘上的数据库。
- 即时更新
  - 事务的某些操作达到提交点前被写入数据库，恢复时需要UNOD/REDO；
  - 如果事务在达到提交点前所有的更新已被写入数据库，需要算法UNDO/NO-REDO。

## 基于延迟更新的恢复技术

对数据库的任何实际更新延迟或推迟到事务成功完成并到达提交点之后进行，适用于较短的事务。

优点：无需UNDO，简化恢复；

缺点：到达提交点之前的缓存区必须保存事务的修改，可能导致缓存区空间开销过大。

## 基于即时更新的恢复技术

当事务发出更新命令时数据库可以立即更新，无需等待事务到达提交点，存在两种恢复算法：

- UNDO/NO-REDO
- UNDO/REDO

# 检查点技术

DB系统通过采用周期性的创建一些检查点，大幅减少或降低恢复所需时间或工作量。

## 检查点的基本思想

- 在日志文件中增加检查点标志记录，并在检查点标志记录写到稳存之前，完成一些必要的、到现在为止的“阶段性”归总工作；
- 当系统崩溃后重启时，重做扫描开始点和撤销回溯终点，就不再总是日志的首条记录。

## 静态检查点和模糊检查点

- 系统建立一个检查点需要一定的时间；
- 根据建立检查点期间，是否允许继续执行事务，或启动新事务，可将检查点分为静态检查点和动态检查点。
  - 静态检查点管理相对简单，但它会影响系统的性能；
  - 动态检查点也称为模糊检查点，它对系统影响不大，但管理相对复杂。

## ARIES日志的系统崩溃恢复

WAL、fuzzy checkpoints

- 相对简单且系统化的方式，提供一套能确保事务原子性和持久性的、具有良好性能的恢复管理算法。
- 与绝大多数并发控制机制协调；
- 减少恢复时间和减少检查点开销，避免重做许多已重做的日志操作。

### 综述

- 使用日志顺序号（LSN）标志日志记录，在数据库页中用LSN标志哪些更新已经在数据库页上实施过。
- 使用脏页表最大程度地减少恢复时不必要的重做。（脏页表：该页变脏的最早LSN）
- 使用模糊检查点机制，只记录脏页信息和关联的信息，甚至不要求将脏页写到磁盘。

当系统崩溃后重启时，恢复管理器将被激活，并按一下三个阶段进行处理：

- 分析：鉴别崩溃发生时，缓冲区中的脏页和当时仍活跃的事务；
- 重做：重做从日志的适当起点（被修改的最早脏页对应日志记录）开始的所有动作，恢复系统到崩溃时的DB状态；
- 撤销：撤销上次崩溃时所有未提交事务的动作效果，使DB只反映已提交事务的影响。

### ARIES日志记录类型

Commit、Abort、End、CLR

### 其他相关数据结构

#### 事务表

- 每个活跃事务占一个表项；
- 每个表项内容：$<tranID, status, lastLSN>$，status可以是正在进行（U）、提交（C），中止（A）

#### 脏页表

- 缓冲池中每个脏页占一个表项；
- 每个表项内容：$<PageID, recLSN>$

ARIES DB的每个页都有page_LSN域。

### ARIES崩溃恢复

> https://my.oschina.net/fileoptions/blog/2988622

- 从最后一个检查点开始扫描（通过查找主记录可获得该LSN）
- 算法三个阶段：
  - 找出从检查点后哪些事务提交，哪些事务失败了；
  - REDO所有动作（重复历史）
  - UNDO所有失败事务的影响。

# ORACLE备份和恢复

物理备份：RMAN备份与恢复、操作系统工具备份与恢复……

- 冷备份：脱机备份；
- 热备份：联机备份或归档备份。

逻辑备份：导出和导入、数据泵、闪回操作……

Oracle备份恢复的方式有两种：使用Recovery Manager进行备份恢复、手工管理的备份恢复。

## 归档与不归档

### 不归档模式

不归档Redo Log文件，日志文件Redo Log被循环使用，当检查点发生后，Redo Log文件可以立即被重用。一旦Redo Log文件被覆盖，介质恢复只能恢复到上次完全备份状态。

适用于：两次备份之间发生数据丢失是允许的，且数据能够很快恢复或很少改变。默认情况下处于不归档模式。

### 归档模式

归档后台进程重写重做日志文件前将每个重做日志文件做一份拷贝。

## 备份简介

### 一致性备份

备份所包含的各个文件中的所有修改都具备相同的数据变化编号（SCN），同一时间点备份。步骤：

1. 关闭数据库
2. 备份所有相关的数据库文件
3. 打开数据库

### 非一致性备份（热备份）

数据库处于打开状态或异常关闭后，对一个或多个数据库文件进行的备份。适用于24*7工作的数据库。

### 数据库完全备份

所有数据文件及控制文件都进行备份。

### 数据库部分备份

只备份表空间、数据文件、控制文件等。

### 表空间备份

构成表空间的数据文件的备份。表空间备份可以是联机的或脱机的，但数据库必须运行在归档模式下表空间备份才是有效的。

### RMAN备份

RMAN与操作系统复制的区别在于，RMAN能够验证备份文件内数据块的有效性，并在资料库中记录复制的情况。

用于备份和还原数据库文件、归档日志和控制文件，也可以用来执行完全或不安全的数据库恢复。可以做物理块的细粒度备份。注：RMAN不能用于备份初始化参数文件和口令文件。

## 恢复简介

- 复原：利用备份重建数据文件或控制文件并使其在Oracle数据库服务器中正常工作。
- 恢复：利用归档重做日志及联机重做日志对数据文件进行更新，重做备份后发生的操作。
- 闪回：修正逻辑数据错误或用户操作失误。（不安全恢复）

介质恢复：先利用备份复原数据再应用重做日志的恢复。

