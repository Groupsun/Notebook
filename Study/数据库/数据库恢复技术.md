# 一些相关的前导知识

## 故障类型

### 事务失败

- 逻辑错误：一个事务由于其内部错误，导致不能正常结束（如事务内部的死循环）；
- 系统错误：系统进入一个不良状态（如死锁），导致事务无法执行。但该事务在以后的某个时间可以重新执行。

### 系统崩溃

电源问题、其他软硬件引起的系统停机。

### 硬盘故障

可能会导致数据的丢失

## 故障恢复策略

1. 系统故障或事务故障的恢复

   会造成DB不一致状态。恢复方法：

   - 撤销UNDO故障发生时未完成事务对DB的所有影响，确保事务的原子性。
   - 重做REDO已成功提交的已完成事务，实现事务的持久性。
   - 一般由系统在重新启动时自动完成，不需要用户干预。

2. 灾难性或磁盘失败恢复

   使用归档存储设备上的数据库备份进行恢复，并从备份日志重新应用或重做已提交事务的操作来重构故障前数据库的最新状态。

## 数据访问

磁盘和主存间的块移动由下面两个操作引发：

- Input(B)：传送物理块B到主存
- Output(B)：传送缓冲块B到磁盘，并替换磁盘上相应的物理块

当事务第一次需要访问数据项X时，它必须执行read(X)，事务最后一次访问X后，它必须执行write(X)，在数据库中反映X的变化。X所在的缓冲块Bx上的操作output(BX)不需要在write(X)执行后立即执行，因为块Bx可能包含其他仍在被访问的数据项。因此，可能一段时间以后才真正执行输出。

## 磁盘块的高速缓存

- 缓存目录：跟踪哪些数据项在缓冲区中；
- 脏位：每个缓冲区都和一个脏位相关联；
- pin-unpin bit：如果缓冲中的页目前还不能写回到磁盘，则称该页被pin。

## 原位更新和镜像更新

将修改过的缓冲区刷新到磁盘，由两种策略：

- 原位更新：将缓冲区写回磁盘原来的位置，因而会覆盖被修改数据项在磁盘上的旧值。
- 镜像更新：将缓冲区写到磁盘不同的位置，可以保存数据项的多个版本。

数据项更新前的旧值称为前像（BFIM），更新后的新值称为后像（AFIM）。

## WAL规则

WAL，The Write-Ahead Logging Protocol，时一个日志协议规则，明确定义了“先写日志”的思想：

- 先写日志，是保证原子性的关键；
- 在事务提交前将事务相关的所有日志记录写到稳定存储介质，这是保证持久性的关键，确保我们能基于日志重建提交事务。

## 潜入/非潜入和强制/非强制

steal、no-steal和force、no-force确定了何时把数据页从告诉缓存写回到磁盘。

- 如果缓存中被事务更新的某个页在事务提交之前不能写回到磁盘，称为非潜入。反之则为潜入。
- 如果事务所有的已更新的页在事务提交时被立即写回磁盘，称为强制方法。反之则为非强制。

# 基于日志的恢复

基于原位更新的恢复必须使用日志。

## 日志种类

### 种类1

把写操作记录下来：