# 引言与网络体系结构

1. 截至2019年6月，中国网民人数已达8(.54)亿，而申请到的ipv4地址维持在3(.86)亿。

2. 沙漏网络体系结构中，最核心也最易出问题的地方是**IP层**。

# IPv6协议

## IPv4的危机

**地址危机**、端到端业务模式无法实施、QoS性能问题、配置复杂、安全问题、路由表的膨胀、移动性支持不够。

## IPv4与IPv6地址空间

IPv4：$2^{32}$约等于43亿；IPV6：$2^{128}=3.4 \times 10^{38}$。

## IPv6的改进之处

简化的报头格式，地址扩展到128位，增强的安全性和服务质量，可以实现更高效的路由基础，提高了对移动性的支持。

## IPv9网络

256位地址，表示方式：y[y[y[y[y[y[y[y

## 4层TCP/IPv6参考模型

应用层（Application Layer）- 传输层（Transport Layer）- 网络层（Internet Layer）- 链路层（Link Layer）

## IPv6特点

- 地址及寻址
- **全新的报文格式，高效的报头**
- **全新的地址配置方式，即插即用**
- 更好的QoS支持
- 内置的安全性
- **全新的邻居发现协议**
- 良好的扩展性
- 内置的移动性
- 端点分片

## IPv6基本术语

- **交换机**边界：局域网
- **内部子网路由器**边界：链路
- **子网网关路由器**边界：子网

## IPv6地址格式

冒分十六进制：省略前导0、忽略全0.

eg：2001:0410:0000:0001:0000:0000:0000:45ff -> 2001:410:0:1:0:0:0:45ff-> 2001:410:0:1::45ff

注意，缩写中不能存在两个"::"结构。

## IPv6地址分类

- 单播地址
  - 源IPv6地址必须是单播地址
  - **本地链路地址**、**全局单播地址**、唯一本地地址、环回地址、嵌入式IPv4地址、未指定地址。
- 组播地址
- 任播地址

## 本地链路地址

- 本地链路地址用于与同一链路中的其他设备通信。（单一链路）
- 路由器不会转发源地址或者目的地址是本地链路地址的数据包。
- 每个支持IPv6的网络接口都一定会有本地链路地址。
- 和IPv4不同，IPv4不会自动生成链路地址，但是IPv6则会，允许支持IPv6的设备和同一子网中的设备通信，包括与默认网关（路由器）通信。

## 链路本地地址构成/生成

应用范围：只能再同一本地链路节点之间使用：**FE80::/64**

节点启动时，自动配置一个本地链路地址。

生成本地链路地址：前64位：FE80:0:0:0，后64位：EUI-64地址

EUI64: MAC地址高24位（高位数下来第7位取反）+11111111 11111110+MAC地址低24位

## IPv6本地链路地址的各种用途

- 主机使用本地路由器的本地链路地址作为默认网关的IPv6地址。
- 路由器使用本地链路地址交换动态路由协议信息。
- 转发IPv6数据包时，路由器的路由表使用本地链路地址确定下一条路由器。

## 环回地址：::1/128

主机使用环回地址发送数据包到其自身，环回地址不能分配给物理接口；对IPv6环回地址使用ping测试本地主机的TCP/IPv6配置。

## 未指定地址：::/128

不能分配给接口，只有在设备尚无永久的IPv6地址时才能作为源地址。不能作为目的地址。

## 唯一本地地址

范围：FC00:/7 - FDFF::/7

在一个站点内或有限站点数之间用作本地地址，在全局不具可路由性。

## 可聚合全球单播地址

地址前缀由格式前缀标识（最高的3位）：001，设计目标是聚合或汇总该地址以便产生有效的路由基础结构。

地址组成：ISP提供商分配的前缀（48）+子网ID（16）+接口ID（64），前缀=全局路由前缀+子网ID=64位

子网使用Site拓扑：由组织机构划分子网。

接口ID的三种生成方法：EUI-64、随机生成、手工设置。

## 特殊单播地址

IPv6兼容地址：::w.x.y.z

IPv4映射地址：::FFFF:w.x.y.z

## IPv6组播地址

|    8     |  4   |  4   |          80           |    32    |
| :------: | :--: | :--: | :-------------------: | :------: |
| 11111111 | flgs | scop | reserved must be zero | group ID |

- flgs：**0001**或**0000**；用来表示permanent（0000）或临时组播组（0001）；
- scop：表示组播组的范围；
- Group ID：组播组ID。

eg: FF02::1 - 链路范围所有节点组播地址；FF02::2 - 链路范围所有路由器组播地址；

FF01::1、FF01::2：节点范围……

## 被请求节点组播地址

**用于重复地址监测和获取邻居节点的链路层地址**，凡是单播地址后24位相同的接口自动加入相应的请求节点组播组。

前104位：FF02::1:FF

后24位：单播地址后24位

## 任播

目标地址为任播地址的数据报将发送给最近的一个接口，适用于One-to-One of Many（一对多之一）的通信场合。

任播地址从单播地址空间中分配，用于标识一组网络接口。任播地址只能作为目标地址，且仅分配给路由器。

## 一台主机上的多个IPv6地址

|           含义           |                       地址                       |
| :----------------------: | :----------------------------------------------: |
|       链路本地地址       |                    FE80::/64                     |
|         环回地址         |                     ::1/128                      |
|     所有节点组播地址     | FF01::1（本地接口范围）, FF02::1（本地链路范围） |
| 分配的可聚合全球单播地址 |                     2000::/3                     |
|    被请求节点组播地址    |                FF02::1:FF**:/104                 |
|   主机所属组的组播地址   |                     FF00::/8                     |

## IPv6子网规划

- IPv4子网划分是管理地址稀缺性；
- IPv6子网划分是根据路由器的数量及它们所支持的网络来构建寻址分层结构。