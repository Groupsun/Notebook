# 8051微控制器基本架构

使用8051作为例子来设计嵌入式系统，首先了解8051的基本架构。

## 基于8051的设计

### 8051的基本架构

8051的基本架构，包含具有布尔处理能力的8位CPU，振荡驱动单元、4KB的片上程序存储器、128字节的内部数据存储器、128字节的专用功能寄存器存储区、32位通用I/O连接线构成的4个8位双向端口（端口0 ~ 3）、2个16位定时器单元、一个用于串行数据传输的全双工可编程UART（具有可配置的波特率）。

### 存储器结构

8051是基于哈佛结构的处理器，在逻辑以及物理上，其程序存储器和数据存储器都是分离的，两者分配了独立的地址空间。8051的地址总线是16位宽度，其存储空间寻址范围为64KB。

1. 程序存储器

    8051的基本架构中，至少具有4KB的片上程序存储器，对比8031来说，8031没有ROM，需要片外存储器。当然，在8051中可以通过更改管脚EA\(External Access)的逻辑电平来在内部存储器与外部存储器之间切换：

    - EA\设置为逻辑1（Vcc），芯片配置为内部程序执行模式（使用内部ROM）。系统首先从内部存储器执行程序指令（4KB，结束地址为0FFFH），然后从外部存储器开始执行（从1000H开始）。
    - EA\设置为逻辑0（GND），芯片配置为外部程序执行模式，系统完全从外部存储器执行程序指令。

    执行外部存储器的控制信号是PSEN\。在内部存储器访问模式中，获取PSEN\是无效的。对于8031，在程序中获取PSEN\总是有效的。

    当使用外部存储器作为程序存储器的时候，需要使用16为的I/O连接线用于外部存储器的访问（8051的地址是16位）。此时，端口0和端口2用于外部存储器的访问。其中端口0作为多路复用的地址/数据总线。在从外部存储器读取数据的时候，端口0首先发出地位地址，然后通过8051发出ALE（Address Latch Enable，地址锁存使能）信号，将低8位地址锁存到8位外部锁存器当中（如74LS373），地址锁存后，端口0的工作模式就变为输入端口，用于对应存储器地址的数据的传输。

    程序的指令是由PC提供的，8051的PC由两个8位寄存器组成一个16位的地址寄存器。低位字节由PCL寄存器保存，高位字节由PCH寄存器保存。在外部ROM取指期间，端口0发出PCL内容，然后ALE信号有效，低位地址锁存到外部锁存器当中，接着端口0变为高阻态，变为输入端口，等待外部数据。端口2一直发送PCH寄存器中的内容，待外部存储器从外部锁存器以及端口2中得到16位地址后，只要PSEN\有效，来自外部ROM的数据就会定时输入端口0。因此，在外部ROM访问的期间，端口0和2都是专用的。


2. 数据存储器

    8051的基本架构中，支持128字节的内部数据存储器和128字节的专用功能寄存器存储区。对于通用的数据存储器需求，专用功能寄存器存储区是不可用的。内部数据存储器的地址范围为00H ~ 7FH。专用功能寄存器存储区的地址范围为80H ~ FFH。由于8051支持的寻址空间大小为64KB，因此支持外部数据存储器。用于外部数据存储器访问的控制信号是RD\和WR\，用于访问外部数据存储器地址的16位寄存器是数据指针（DPTR）。

    数据指针寄存器与PC类似，也是由两个8位的寄存器组成：对应低8位的DPL和对应高8位的DPH。它与PC的区别是，用户无法访问PC，但是可以访问DPTR，同时DPTR中的内容也是可以修改的。内部存储器的地址长度为8位，可以寻址的空间为128B。可以通过使用间接寻址的方式访问更高位的地址。需要注意的是，通过间接寻址来扩展寻址空间的方法必须物理实现了才可行，比如8051没有实现高位的数据存储器，而8052则有，也就是说，8052可以通过间接寻址的方式访问高位的地址。

    外部数据存储器的访问方式和外部程序存储器的访问方式相似，在这里不再赘述。

3. 页面数据存储访问

    页面寻址模式中，使用高位地址法则来对地址进行索引。假设最高位作为页面，也就是说，将存储器分为两个页面：

    - 页0：000H ~ 0FFH
    - 页1：100H ~ 1FFH

4. 8051的冯-诺依曼存储器模型

    通过将8051的程序存储器和数据存储器结合在一起使用，可以构成冯-诺依曼结构。只需要一个外部的支持读/写操作的存储芯片就可以满足这个要求。程序存储空间可以从0地址开始，而数据存储空间排在程序存储空间之后。将PSEN\和RD\通过一个与门连接，然后输出到外部存储器的OE\管脚即可。

    使用同一个存储器的主要缺陷在于：

    - 无法应对程序存储器的突然崩溃。
    - 总的存储空间变小了。在哈佛结构中，程序和数据存储器共有128B的空间寻址，而现在是64B的空间。

5. 低128字节内部数据存储器的结构

    最低的32个字节（00H ~ 1FH）分为4组，每组8个寄存器，这些寄存器成为R0 ~ R7寄存器，在程序运行期间可以用作临时数据寄存器。在代码中有效利用这些寄存器，可以减少代码存储器的需求（寄存器指令比直接存储器寻址指令相比更短）。

    然后的16个字节（20H ~ 2FH）是RAM支持位寻址的区域，当然也可以用作字寻址。但注意两者不能在同一个字节地址上混用。

    最后的80个字节（30H ~ 7FH）用作暂存通用中间结果的RAM。

6. 高128字节RAM（专用功能寄存器）

    高128字节RAM用作专用功能寄存器SFR，SFR中含有端口锁存器、状态与控制位、定时器控制、数值寄存器、CPU寄存器、栈指针、累加器等。SFR寄存器中有些只能在字节量级访问，有些则既能够在字节量级访问，也能在位量级访问。

7. 高128字节中间结果暂存RAM（IRAM）

    在8052系列芯片中，物理上实现了高128字节的RAM。因此可以通过间接寻址的方式，将中间结果暂存在高128字节中。方式如下：

    ```Assembly
    MOV     R0, #80H
    MOV     A, @R0
    ```

### 寄存器

广义上，8051的寄存器分为两类：CPU寄存器和中间结果寄存器。

#### CPU寄存器

1. 累加器（SFR-E0H）

    用作所有与算术运算相关的CPU计算。在大多数的算术运算中，累加器用于存放隐式的操作数。累加器支持位寻址。

2. B寄存器（SFR-F0H）

    用于存放乘法和出发操作数的CPU寄存器。该寄存器也可以存放除法的余数，以及乘法指令中的MSB。此外，B寄存器还可在编程中用作通用寄存器。

3. 程序状态字PSW（SFR-D0H）

    PSW寄存器的详细位结构：

    <table>
        <tr>
            <th>PSW.7</th>
            <th>PSW.6</th>
            <th>PSW.5</th>
            <th>PSW.4</th>
            <th>PSW.3</th>
            <th>PSW.2</th>
            <th>PSW.1</th>
            <th>PSW.0</th>
        </tr>
        <tr>
            <th>CY</th>
            <th>AC</th>
            <th>F0</th>
            <th>RS1</th>
            <th>RS0</th>
            <th>OV</th>
            <th></th>
            <th>P</th>
        </tr>
    </table>

    - CY：进位标志。当两个8位数的加法运算中发生进位的时候，或者是两个8位数减法中发生错位的时候，该位设为1。
    - AC：辅助进位标志。加法运算中，如果产生的进位超过了3位，该位设为1。
    - F0：标志0。用户可编程的通用标志位。
    - OV：溢出标志。当溢出发生时，该标志置1。执行有符号加法的时候，OV置位说明两个正数之和溢出产生负数，或是两个负数之和溢出产生正数。
    - P：奇偶标志。在每个指令周期内，通过硬件置1或清零，来指示累加器中存在奇数个1还是偶数个1。如果累加器中有奇数个1，则P=1，否则P=0。
    - PSW.1：通用标志。用户可编程的通用标志位。
    - RS1、RS0：寄存器分组选择器。

    RS0以及RS1是寄存器的分组选择器，如00 ~ 11分别表示选择的是第0 ~ 3组的寄存器组。系统上电复位的时候，RS0和RS1复位为0，默认的寄存器分组是0。通过更改RS0和RS1的值，可以改变寄存器的分组情况：下面的汇编代码将选择第2组作为中间结果寄存器组。

    ```Assembly
    CLR PS0         ;PS0寄存器置零
    SETB PS1        ;PS1寄存器置1
    ```

4. 数据指针

    数据指针寄存器由两个8位的寄存器组成，分别是DPL和DPH。

    - DPL：SFR-82H
    - DPH：SFR-83H

    DPTR保存着外部寄存器的16位地址，可以用于外部数据存储器的读/写操作。

5. 程序计数器PC

    16位的寄存器，用于保存来自代码存储器的取指地址，对于编程人员是不可见的。

6. 栈指针（SFR-81H）

    用于保存栈存储器当前地址的8位寄存器。在栈存储器中，存储着程序计数器地址以及在子例程/子函数调用中需要保存的其他存储器和寄存器的值。

#### 中间结果寄存器

如上所述，中间结果寄存器R0 ~ R7位于低32字节的内部RAM当中，通过使用PSW寄存器的模式选择位RS0和RS1来选择四组寄存器组中的其中一组来作为当前可用的寄存器组。

### 振荡器

振荡器是负责生成时钟信号的器件。8051系列微控制器上包含了所需的所有振荡器驱动电路，唯一需要的外部连接元件是陶瓷晶体谐振器，通过两个外部管脚XTAL1以及XTAL2提供了外部接口的能力。

时钟由振荡器提供，用于驱动数字电路。芯片的运行速度取决于时钟速度。

#### 时钟速度

处理器的运行速度与振荡器时钟频率成正比。在8051的指令集中，根据具体指令的不同，单条指令所需的时钟周期为1 ~ 4个机器周期。

每个机器周期由状态序列组成，称为T状态。最初的8051处理器中，机器周期包括6个T状态，分别为S1、S2、S3、...、S6。每个T状态又包含两个振荡器周期（时钟周期）。因此在一个机器周期内，共包含12个时钟周期。

### 端口

端口是一组I/O连接线。每个端口都有独立的端口控制单元、端口驱动器和缓冲器。最初的8051支持32条I/O连接线，4个I/O端口，每个端口对应8条I/O连接线。每条I/O导线上都连接了一个输出驱动器和一个输入驱动器。着四个端口都是双向的，每个端口上都连接了相应的8位锁存器。

#### 端口0

如上文所述，端口0是双向端口，在外部数据存储器和程序存储器的工作过程中，用作多路复用的地址/数据总线。

端口中每个管脚都对应着1位的锁存器，是端口0专用功能寄存器SFR的一部分。因此，对端口有两种不同的操作，读管脚和读锁存器。读锁存器是读出相应端口的SFR/SFR位锁存器中的数据。而读管脚则读出相应端口管脚的状态。

#### 端口1

端口1是用作通用I/O端口的双向端口。

#### 端口2

端口2设计用于两种不同的模式。在常规的工作模式下，端口2用作通用I/O端口；在外部数据存储器/程序存储器访问模式下，端口2用作高位地址总线。

#### 端口3

端口3是具有两用功能的通用I/O口。

#### 读端口锁存器与读端口管脚

读端口锁存器操作是由控制信号读锁存器触发的，执行实现读锁存器操作的指令的时候，系统内部将生成读锁存器控制信号。

读-修改-写指令则对相应端口进行读操作，修改数据，并且将数据重新写入相应的端口，操作作用是在端口锁存器上的。也就是说，如指令“MOV Px.y C”都是读出端口x对应的字节数据，对y位进行修改，并且将修改后的字节写回Px锁存器。

#### 8051端口的源电流与反向电流

1. 源电流

    源电流是指为了驱动外部连接设备，8051端口管脚可以提供的最大电流。

2. 反向电流

    反向电流是指外部设备可以通过8051端口管脚获得的最大电流。

### 中断

#### 中断的定义

中断时用于中断程序执行的信号。在正常程序执行流程中，用于指示系统变化的信号。在程序正常执行的过程中，该中断信号的来源可能是连接到微处理器/微控制器上的外部设备，要求系统立即注意。同时中断信号也有可能来源于处理器/控制器的某些内部单元，比如定时器溢出指示信号。一般将第一种类型的中断称为外部中断。

#### 使用中断的原因

中断可以用于从外部设备读出数据以及想外部设备写入数据的情景。如果外部设备支持中断，设计者可将设备的中断管脚连接到控制器的中断线上。在固件的设计中，先使能相应的中断，然后再独立的函数中，编写处理中断请求服务的代码，并将其他任务放在主程序的代码中。

#### 中断的使用

- 外围设备与处理器/控制器之间的I/O传输；
- 定时应用；
- 突发事件处理；
- 上下文切换/多任务/实时应用编程；
- 基于事件驱动的编程。

### 8051中断系统

基本型的8051和其对应的不含ROM的8031AH支持5种中断源：2个外部中断、2个定时器中断、1个串口中断。其中，串口中断是两个串口中断进行或运算的结果，两个串口中断分别是接收中断和发送中断。

#### 中断使能

在8051的中断系统中，可完全由软件来控制中断的使能或禁用。通过对专用功能寄存器中断使能中的全局中断使能位进行置位或者清零，可以分别实现中断的使能与禁用。此外，在SFR中断使能中，通过对相应的中断使能位进行置位或者清零，还可以单独对相应的各个中断进行使能或者禁止。

**中断使能（SFR-A8H）**

<table>
    <tr>
        <th>IE.7</th>
        <th>IE.6</th>
        <th>IE.5</th>
        <th>IE.4</th>
        <th>IE.3</th>
        <th>IE.2</th>
        <th>IE.1</th>
        <th>IE.0</th>
    </tr>
    <tr>
        <th>EA</th>
        <th>RSD</th>
        <th>RSD</th>
        <th>ES</th>
        <th>ET1</th>
        <th>EX1</th>
        <th>ET0</th>
        <th>EX0</th>
    </tr>
</table>

其中寄存器各位的命名和功能如下：

- EA：全部使能。如果EA=0，禁用所有中断。如果EA=1，使能所有中断，此使分别对中断使能SFR中对应的使能位进行置位使能。
- RSD：预留。
- ES：串口使能。
- ET1：定时器1使能。
- EX1：外部中断1使能。
- ET0：定时器0使能。
- EX0：外部中断0使能。

需要注意的是，在IE寄存器当中，如果IE寄存器的全局中断使能EA位等于0，那么即使对应的中断位处于置位状态，也不能对中断进行使能，也就是得不到中断服务。

#### 中断优先级设置

通过软件控制操作，可以对中断优先级进行设置。在专用功能寄存器中，中断优先级寄存器用于为各个中断保存中断优先级设置。

**中断优先级寄存器（SFR-B8H）**

<table>
    <tr>
        <th>IP.7</th>
        <th>IP.6</th>
        <th>IP.5</th>
        <th>IP.4</th>
        <th>IP.3</th>
        <th>IP.2</th>
        <th>IP.1</th>
        <th>IP.0</th>
    </tr>
    <tr>
        <th>RSD</th>
        <th>RSD</th>
        <th>RSD</th>
        <th>PS</th>
        <th>PT1</th>
        <th>PX1</th>
        <th>PT0</th>
        <th>PX0</th>
    </tr>
</table>

中断优先级寄存器各位含义列表：

- RSD：预留；
- PS：串口中断优先级。PS=1，串口中断设置为优先（下述位含义皆同，不再赘述）。
- PT1：定时器1中断优先级；
- PX1：外部中断1优先级；
- PT0：定时器0中断优先级；
- PX0：外部中断0优先级。

在8051的中断控制系统中，锁存器用于保存各个中断的状态。每个机器周期的S5P2期间，各个中断标志的状态会被锁存和更新；并在后续机器周期中，对被锁存的中断标志进行轮循。在前一个机器周期的S5P2期间，如果发现已经使能的中断标志处于置位状态，那么在代码存储器当中，中断系统会将程序流程转移到对应的中断服务例程（前提是没有阻止该中断执行的条件）。在代码存储器中，各中断的中断服务例程的地址为：

<table>
    <tr>
        <th>中断序号</th>
        <th>中断源</th>
        <th>代码存储器中的ISR地址</th>
    </tr>
    <tr>
        <th>0</th>
        <th>外部中断0</th>
        <th>0003H</th>
    </tr>
    <tr>
        <th>1</th>
        <th>定时器0中断</th>
        <th>000BH</th>
    </tr>
    <tr>
        <th>2</th>
        <th>外部中断1</th>
        <th>0013H</th>
    </tr>
    <tr>
        <th>3</th>
        <th>定时器1中断</th>
        <th>001BH</th>
    </tr>
    <tr>
        <th>4</th>
        <th>串口中断</th>
        <th>0023H</th>
    </tr>
</table>

8051中断基本工作规则：

1. 如果同时接收到两个不同优先级的中断请求，系统优先响应具有高优先级的中断请求。
2. 如果同时接收到多个相同优先级的中断请求，响应顺序按照中断标志的内部轮询顺序。
3. 低优先级中断总是可以被高优先级中断打断。
4. 低优先级中断在运行过程中，不可能被另一个低优先级中断打断。
5. 高优先级中断在运行过程中，不可能被低优先级或者同优先级中断打断。

#### 阻止中断执行的各种条件

在8051架构中，以下情况可以阻止中断请求：

1. 由于中断使能寄存器的EA位被清零；
2. 通过对中断使能寄存器中特定的使能位进行清零，单独禁用某个中断；
3. 当前高优先级中断或者同优先级中断已经处于运行状态；
4. 对于当前运行的指令而言，在程序跳转到中断服务例程之前，必须确保运行中的指令已经执行完毕。
5. 当前运行的指令是RETI或者向IE/IP寄存器写入数据（确保与中断相关的指令不会产生矛盾）。

上述条件1、2、3下，中断完全不会得到服务。条件4、5下，则是经过一段时延后，才会转到中断服务例程执行。

#### 从中断服务例程返回

中断服务例程应该以RETI结束，这是响应ISR最后指令的指令。执行RETI会通知中断系统，对应的中断服务例程已经执行完毕，处理器会对相应的触发器清零，清除其运行中标志优先级-X的中断，表示系统现在可以接受低优先级后者同优先级的任何其他中断。执行RETI指令，将从栈存储器内找回中断前的PC内容，程序重新回到中断发生的位置，继续执行后续指令。

需要注意的是，RETI表明从中断服务例程返回，RET表明从正常程序的返回。RETI对运行中的中断标志清零，并找回中断前的程序计数器寄存器内容，使程序重新回到中断发生的未知，继续执行后续指令。

**注意：对于那些没有得到服务的中断，将不会在稍后的时间中得到服务。**

#### 8051的中断优先级

8051支持两个优先级，第一个优先级取决于中断优先级寄存器的配置，第二个优先级取决于内部硬件的轮询序列。如果两个中断优先级相同的中断请求同时发生，系统将基于内部轮询序列的优先级来确定相应哪个中断。

在系统内部的轮询序列中，优先级顺序从高到低排列为：外部中断0、定时器0溢出中断、外部中断1、定时器1溢出中断、串口中断。

#### 中断发生的具体处理过程

1. 继续完成运行中的指令执行。
2. 将PC对应于代码存储器的下一条将要被执行的指令的地址，将该地址自动压入栈存储器。其中PCL先入栈，PCH稍后入栈。
3. 如果中断是定时器或者外部中断，那么对应的中断标志清零。
4. 对于运行中的中断，对其触发器进行置位。
5. 在代码存储器中，使用长调用（LCALL）指令转向中断服务例程对应的地址（中断向量）。

#### 中断延迟

中断延迟指的是中断信号到达与相应ISR开始执行之间的时间。

在实际应用当中，中断延迟是一个显著的问题。因为即使中断发生在S1P1，系统仅在S5P2上锁存，并且在下一个机器周期的S5P2期间进行轮询。即使在转向ISR地址后，还会存在一些时延，比如对某些需要保存的寄存器进行压栈等。在ISR服务过程中，中断延迟由以下部分时延加和组成：

中断信号到达与S5状态开始之间时间+(((1+1+12)x2)/Fosc)秒

其中，1个时钟周期 =  1/Fosc

简而言之，在8051系统中，中断的响应时间总是大于3个机器周期，小于9个机器周期。

#### 配置外部中断

8051支持两个外部中断：外部中断0和外部中断1。这是两个硬件中断，端口3的两个端口管脚用作这两个外部中断的输入连接线。外部中断信号可以是电平触发的，也可以是边沿触发的。

配置外部中断信号触发方式，通过SFR定时器/计数器控制寄存器（TCON）来完成。TCON.0配置外部中断0，TCON.2配置外部中断1。

### 定时器

定时器是用于生成精确时间基准的基本部件。定时器可以用软件或者硬件来实现。硬件定时器是专用于硬件单元的，其定时精度较高。在8051架构当中，支持两个16位的硬件定时器，可以配置其工作在定时器模式下或者在外部事件计数模式下。两个定时器分别命名为定时器0和定时器1。如果定时器工作在定时器功能模式下，那么定时器在每个机器周期，定时器寄存器储存的值都会递增1。因此定时器的递增频率为：Fosc/12。

如果定时器配置为外部计数模式，那么当响应外部管脚上电平下降沿触发时，定时器寄存器中的数值递增，具体实现为：在每个时钟周期的S5P2期间，系统对外部输入管脚进行采样，如果结果表明在一个时钟周期S5P2是高电平，而在下一个采样时刻变为低电平，那么计数器寄存器中的数值递增1。

计数器跟新只发生在机器周期的S3P1状态，而且是检测到电平跃迁之后。因此至少需要两个机器周期才能识别一个下降沿，因此外部事件的最大计数频率是Fosc/24。

通过使用定时器/计数器模式控制寄存器（TMOD）来配置定时器：

**定时器/计数器模式控制寄存器（SFR-89H）**

<table>
    <tr>
        <th>BIT7</th>
        <th>BIT6</th>
        <th>BIT5</th>
        <th>BIT4</th>
        <th>BIT3</th>
        <th>BIT2</th>
        <th>BIT1</th>
        <th>BIT0</th>
    </tr>
    <tr>
        <th>GATE</th>
        <th>C/T</th>
        <th>M1</th>
        <th>M0</th>
        <th>GATE</th>
        <th>C/T</th>
        <th>M1</th>
        <th>M0</th>
    </tr>
</table>

其中高4 ~ 7位配置定时器1，低0 ~ 3位配置定时器0。

TMOD寄存器各位含义：

- GATE：选通控制。
    - GATE = 1：只有当INT0/INT1线处于逻辑高电平状态，且TCON寄存器中对应的定时器/j计数器运行位TR已经使能的时候，响应的定时器/计数器才会开始工作。
    - GATE = 0：当TCON寄存器中对应的定时器/计数器运行位TR已经使能的时候，定时器/计数器就会开始工作。
- C/T：计数器/定时器选择器。
    - C/T = 1：用作计数器。
    - C/T = 0：用作定时器。
- M1、M0：模式选择位。

通过配置M1、M0的值可以使定时器处于4种不同的模式当中，稍后将会赘述。

**定时器/计数器控制寄存器（SFR-88H）**

TCON是支持位寻址的专用功能寄存器，其中保存了定时器/计数器的中断标志和运行控制位。

<table>
    <tr>
        <th>BIT7</th>
        <th>BIT6</th>
        <th>BIT5</th>
        <th>BIT4</th>
        <th>BIT3</th>
        <th>BIT2</th>
        <th>BIT1</th>
        <th>BIT0</th>
    </tr>
    <tr>
        <th>TF1</th>
        <th>TR1</th>
        <th>TF0</th>
        <th>TR0</th>
        <th>IE1</th>
        <th>IT1</th>
        <th>IE0</th>
        <th>IT0</th>
    </tr>
</table>

各个位的含义和用法：

- TFx：溢出标志。当计数器溢出时，该位置1。当定时器中断执行完毕后，该位清零。
- TRx：运行控制。该位为1时，启动定时器/计数器。
- IEx：边沿检测标志。当检测到外部中断边沿时，硬件将该位置1，当中断执行完毕后，该位清零。
- ITx：类型控制。ITx = 1：边沿触发（下降沿），ITx = 0：电平触发（低电平）。

当定时器寄存器由全1变为全0时（即定时器溢出），将会产生定时器溢出中断，定时器0的溢出中断服务程序在000BH，而定时器1的溢出中断服务程序在001BH。

#### 定时器/计数器模式0

当工作在模式0的时候，此时定时器/计数器共有13位。该寄存器的13位组成为THx所有8位以及TLx的低5位。高8位THx的所有8位即为定时器的计数器，因此，当TLx计数到32的时候，计数器THx的值就会递增1。当13位定时器由全1变为全0的时候，将会产生定时器溢出中断。模式0对应的计数范围为：0000H ~ 1FFFH。

#### 定时器/计数器模式1

此工作模式与模式0类似，只是定时器寄存器的长度增加为16位，由THx和TLx组成。

在模式0和模式1中，为了使定时器正常工作，建议将GATE设置为0。

#### 定时器/计数器模式2

当定时器工作在模式2时，当定时器寄存器计数发生溢出，那么TLx可以从THx重新载入。

#### 定时器/计数器模式3

在模式3下，定时器/计数器0用作两个独立的8位定时器/计数器，而定时器/计数器1实际上不工作。两个独立的定时器寄存器分别为TH0和TL0。

### 串口

标准8051支持全双工、带接收缓冲的标准串行接口。专用功能寄存器SBUF为串行接收寄存器和串行发送寄存器提供了通用接口，通过访问SBUF寄存器来实现访问串行接收以及发送寄存器。串口可以工作在4种不同的模式当中，通过对专用功能寄存器串口控制寄存器（SCON）进行置位或者清零操作，可以配置相应的模式选择。

**串口控制寄存器（SFR-98H）**

<table>
    <tr>
        <th>SCON.7</th>
        <th>SCON.6</th>
        <th>SCON.5</th>
        <th>SCON.4</th>
        <th>SCON.3</th>
        <th>SCON.2</th>
        <th>SCON.1</th>
        <th>SCON.0</th>
    </tr>
    <tr>
        <th>SM0</th>
        <th>SM1</th>
        <th>SM2</th>
        <th>REN</th>
        <th>TB8</th>
        <th>RB8</th>
        <th>TI</th>
        <th>RI</th>
    </tr>
</table>

SCON寄存器各位的含义和用法：

- SM0、SM1：串口模式选择，用于设置串口的工作模式。
- SM2：多处理器通信标志。
- REN：串行数据接收使能。
- TB8、RB8：在模式2和模式3中，用于发送和接收到的第9个数据位。
- TI：发送中断。在模式0中，在第8位数据发送结束后，由内部电路进行置位。在其他模式中，在终止位（第9位）发送开始时对其置位。TI由固件清零。
- RI：接收中断。在模式0中，在第8位数据接收结束后，由内部电路进行置位。在其他模式中，在终止位（第9位）接受过程中对其置位。RI由固件清零。

#### 串行通信模式

1. 模式0（SM0 SM1 = 00）

    在模式0中，管脚RXD（P3.0）用作串行数据发送与接收，管脚TXD（P3.1）用作输出需要移位的时钟。每次传输8位数据，且LSB在前。其波特率是固定的，等于振荡器频率的1/12。模式0是半双工的。

    通过对SBUF寄存器进行写访问，可以实现串行数据传输的初始化操作。将所需要传输的数据字节写入SBUF寄存器，寄存器中的数据将会依次移位到RXD管脚，其顺序是LSB在前。移位发生在每个机器周期，知道所有位（包括终止位）都移出管脚。模式0中的终止位为SBUF的MSB。因此，模式0的传输速率是振荡器频率的1/12。

    当所有8位都从管脚移出后，发送控制单元将发送中断TI置位为1。在数据发送的期间，TXD管脚输出发送移位时钟，只有当接受使能位REN置位为1，并且接收中断RI处于清零状态的时候，串行数据接收才会使能。SCON操作（使能REN以及RI清零）完成了数据接收的初始化。

    在每个机器周期，接收控制单元对接收管脚RXD进行采样，将采样数据放在接收移位寄存器的LSB上，并将其左移位。接收完所有8位数据后，接收中断RI置1。接收过程中TXD管脚输出接收移位时钟。

2. 模式1（SM0 SM1 = 01）

    在模式1中，管脚TXD发送串行数据，管脚RXD接收串行数据，是全双工模式。在模式1中，数据发送与数据接收的基本单元是10位，包括1个起始位、8个数据位以及一个终止位，起始位为逻辑0。接收到终止位后，置入SCON的RB8位。波特率可变。通过写访问SBUF寄存器来出发数据发送。SBUF写信号将终止位置入SCON的TB8位。

    模式1的时钟与除16计数器同步。当接收到有效的起始位后，将接收移位寄存器中的内容左移一位，将当前接收到的数据位放在最右边的位置。此后，系统接收到终止位后，将其输入给RB8，将接收中断RI置位为1。只有当接收中断RI等于0并且SCON寄存器中SM2位等于0的时候，或者是最终移位脉冲生成期间接收到的终止位等于1的时候，系统生成载入SBUF的信号、载入RB8的信号以及置位RI的信号。

3. 模式2和模式3

    在模式2和模式3中，每次发送11位。这11位包括：8个数据位、1个起始位（0），1个终止位（1）以及1个可编程位。模式2和模式3同样是全双工的，串行数据发送通过管脚TXD，串行数据接收通过管脚RXD。

    模式2和模式3具有奇偶校验的功能。

#### 支持多处理器/控制器通信

多处理器/控制器通信用于实现多个处理器/控制器之间的通信，这些处理器或者控制器连接到相同的串行接口总线上，每个处理器都分配了相应的地址。

在多处理器/控制器中，一个用作主控制器，其他控制器则用作从控制器。对于8051来说，当每个控制器中的SCON寄存器中的M2都置位为1，那么其模式2和模式3支持多处理器通信。

当主处理器/控制器想要向任意一个从控制器发送一组数据的时候，主控制器首先会发出从控制器相应的控制字节。每个从控制器检查接收到的地址字节是否与自己的地址相匹配。如果匹配，那么将其SM2位清零，等待主控制器的数据字节。

### 复位电路

8051的复位操作具体来说，就是将已知的默认值加载到寄存器中，并将0000H加载到程序计数器PC中。这确保程序从代码存储器的起始地址开始执行，栈将复位到存储地址07H。复位可以分为两种：硬件复位以及软件复位。

### 省电节能模式

8051采用基于CMOS技术工作在省电模式下，其中包括空闲（IDLE）模式和省电（POWER DOWN）模式。

#### 空闲模式

将SFR功率控制寄存器（PCON）的PCON.0置位为1，可以激活空闲模式。此时处理器的内部时钟暂时挂起，在CPU进入空闲状态前，系统会先保存各种CPU状态，比如SP、PC、PSW、累加器以及其他所有寄存器取值。但是中断、定时器、串口将会继续工作。

#### 省电模式

将PCON.1置位为1时，系统激活省电（Power Down）模式。此时，CPU终止指令执行，并停止为所有内部硬件提供信号。不过，内部RAM和SFR中的内容保持不变。

要想从省电模式中退出，只能通过硬件复位来实现。
