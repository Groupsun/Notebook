# 引言与网络体系结构

1. 截至2019年6月，中国网民人数已达8(.54)亿，而申请到的ipv4地址维持在3(.86)亿。

2. 沙漏网络体系结构中，最核心也最易出问题的地方是**IP层**。

# IPv6协议

## IPv4的危机

**地址危机**、端到端业务模式无法实施、QoS性能问题、配置复杂、安全问题、路由表的膨胀、移动性支持不够。

## IPv4与IPv6地址空间

IPv4：$2^{32}$约等于43亿；IPV6：$2^{128}=3.4 \times 10^{38}$。

## IPv6的改进之处

简化的报头格式，地址扩展到128位，增强的安全性和服务质量，可以实现更高效的路由基础，提高了对移动性的支持。

## IPv9网络

256位地址，表示方式：y[y[y[y[y[y[y[y

## 4层TCP/IPv6参考模型

应用层（Application Layer）- 传输层（Transport Layer）- 网络层（Internet Layer）- 链路层（Link Layer）

## IPv6特点

- 地址及寻址
- **全新的报文格式，高效的报头**
- **全新的地址配置方式，即插即用**
- 更好的QoS支持
- 内置的安全性
- **全新的邻居发现协议**
- 良好的扩展性
- 内置的移动性
- 端点分片

## IPv6基本术语

- **交换机**边界：局域网
- **内部子网路由器**边界：链路
- **子网网关路由器**边界：子网

## IPv6地址格式

冒分十六进制：省略前导0、忽略全0.

eg：2001:0410:0000:0001:0000:0000:0000:45ff -> 2001:410:0:1:0:0:0:45ff-> 2001:410:0:1::45ff

注意，缩写中不能存在两个"::"结构。

## IPv6地址分类

- 单播地址
  - 源IPv6地址必须是单播地址
  - **本地链路地址**、**全局单播地址**、唯一本地地址、环回地址、嵌入式IPv4地址、未指定地址。
- 组播地址
- 任播地址

## 本地链路地址

- 本地链路地址用于与同一链路中的其他设备通信。（单一链路）
- 路由器不会转发源地址或者目的地址是本地链路地址的数据包。
- 每个支持IPv6的网络接口都一定会有本地链路地址。
- 和IPv4不同，IPv4不会自动生成链路地址，但是IPv6则会，允许支持IPv6的设备和同一子网中的设备通信，包括与默认网关（路由器）通信。

## 链路本地地址构成/生成

应用范围：只能再同一本地链路节点之间使用：**FE80::/64**

节点启动时，自动配置一个本地链路地址。

生成本地链路地址：前64位：FE80:0:0:0，后64位：EUI-64地址

EUI64: MAC地址高24位（高位数下来第7位取反）+11111111 11111110+MAC地址低24位

## IPv6本地链路地址的各种用途

- 主机使用本地路由器的本地链路地址作为默认网关的IPv6地址。
- 路由器使用本地链路地址交换动态路由协议信息。
- 转发IPv6数据包时，路由器的路由表使用本地链路地址确定下一条路由器。

## 环回地址：::1/128

主机使用环回地址发送数据包到其自身，环回地址不能分配给物理接口；对IPv6环回地址使用ping测试本地主机的TCP/IPv6配置。

## 未指定地址：::/128

不能分配给接口，只有在设备尚无永久的IPv6地址时才能作为源地址。不能作为目的地址。

## 唯一本地地址

范围：FC00:/7 - FDFF::/7

在一个站点内或有限站点数之间用作本地地址，在全局不具可路由性。

## 可聚合全球单播地址

地址前缀由格式前缀标识（最高的3位）：001，设计目标是聚合或汇总该地址以便产生有效的路由基础结构。

地址组成：ISP提供商分配的前缀（48）+子网ID（16）+接口ID（64），前缀=全局路由前缀+子网ID=64位

子网使用Site拓扑：由组织机构划分子网。

接口ID的三种生成方法：EUI-64、随机生成、手工设置。

## 特殊单播地址

IPv6兼容地址：::w.x.y.z

IPv4映射地址：::FFFF:w.x.y.z

## IPv6组播地址

|    8     |  4   |  4   |          80           |    32    |
| :------: | :--: | :--: | :-------------------: | :------: |
| 11111111 | flgs | scop | reserved must be zero | group ID |

- flgs：**0001**或**0000**；用来表示permanent（0000）或临时组播组（0001）；
- scop：表示组播组的范围；
- Group ID：组播组ID。

eg: FF02::1 - 链路范围所有节点组播地址；FF02::2 - 链路范围所有路由器组播地址；

FF01::1、FF01::2：节点范围……

## 被请求节点组播地址

**用于重复地址监测和获取邻居节点的链路层地址**例如NS，凡是单播地址后24位相同的接口自动加入相应的请求节点组播组。

前104位：FF02::1:FF

后24位：单播地址后24位

## 任播

目标地址为任播地址的数据报将发送给最近的一个接口，适用于One-to-One of Many（一对多之一）的通信场合。

任播地址从单播地址空间中分配，用于标识一组网络接口。任播地址只能作为目标地址，且仅分配给路由器。

## 一台主机上的多个IPv6地址

|           含义           |                       地址                       |
| :----------------------: | :----------------------------------------------: |
|       链路本地地址       |                    FE80::/64                     |
|         环回地址         |                     ::1/128                      |
|     所有节点组播地址     | FF01::1（本地接口范围）, FF02::1（本地链路范围） |
| 分配的可聚合全球单播地址 |                     2000::/3                     |
|    被请求节点组播地址    |                FF02::1:FF**:/104                 |
|   主机所属组的组播地址   |                     FF00::/8                     |

## IPv6子网规划

- IPv4子网划分是管理地址稀缺性；
- IPv6子网划分是根据路由器的数量及它们所支持的网络来构建寻址分层结构。

# IPv6地址配置

## 配置方式

- 手工配置（不建议）；
- 无状态地址自动配置（ND协议）；
- 有状态地址自动配置（DHCPv6）；

## 无状态地址自动配置（SLAAC）

无需任何配置即可和外界通信，真正的即插即用；无状态地址自动配置基于对主机使用的IPv6地址的如下结构：由**前缀**和**接口ID**组成。

接口ID：EUI-64

前缀：一般来讲主机地址的前缀就是路由器的前缀。

## 无状态地址自动配置（SLAAC）用到的消息

- Router Solicitation（RS）：促使路由器发送RA信息；（通过FF02::2地址）
- Router Advertisement（RA）：向主机通告前缀等信息；（通过FF02::1地址）

两种信息都是以ICMP报文的形式出现，也是5种ND协议信息种的两种。

## 无状态地址自动配置（SLAAC）中的3个机制

- 路由器发现（通过RS，RA发送信息）
  - 主机选择默认网关；
  - 主机发现前缀，生成前缀列表；
  - 参数发现：发现相关参数的过程，如MTU、条数限制、地址配置方式等。
- 重复地址监测（DAD）；
  - **是节点确定即将使用的地址是否在链路上唯一的过程**；
  - 所有单播地址，不管是自动配置还是手动配置，都必须要通过DAD；
  - DAD机制通过ND中的NS/NA两种消息实现：
    1. 节点发送Neighbor Solicitation（NS）；
    2. 如果收到Neighbor Advertisement（NA）就证明地址重复；（接收者如果发现NS中Target域的地址对它而言是tentative的，那么就放弃使用这个地址；接收者如果发现其中的Target域中的地址是一个它正在使用的地址，则发送NA信息）；一个地址在分配给一个接口后且还未通过重复地址检测前称为tentative地址（试验地址）。
    3. **尝试若干次**发送请求，都没有收到邻居通告，即可启用该地址；
- 前缀重新编址（Redirect）。
  1. 允许网络从以前的前缀平稳地过渡到新的前缀，提供对用户透明的网络重新编址能力。
  2. 在前缀重新编址时，路由器会继续通告当前前缀，只是优先时间和有效时间被减小到接近0，同时，路由器开始通告新的前缀，这样，**链路中至少有两个前缀共存**。
  3. 节点收到这样的RA，会发现当前前缀的生命周期较短，停止使用；同时开始用新的前缀配置接口，并进行DAD，通过后获得新地址使用。

## SLAAC注意事项

- 为了避免RS泛滥，节点启动时最多只能发送3个RS；

- 主机在收到路由器的RA之后，自动设置默认路由器，建立默认路由器列表、前缀列表及其它参数；

- 路由器会主动周期性的发送RA（默认值200s）；

- 自动配置的IPv6地址在系统中有一个生存周期，跟优先时间和有效时间有关：

  ![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\IPv6_SLAAC_lifetime.png)

  1. Preferred Lifetime周期内的前缀生成的地址，任何上层应用都可不受限制地使用；
  2. 超过Preferred Lifetime但未超过Valid Lifetime周期内的前缀生成的地址，正在使用该地址的上层应用可以继续使用，但任何新的上层应用都不应该使用这个地址；
  3. 在超过Valid Lifetime周期内的前缀构造的地址，任何上层应用都不能使用该地址。

一个链路本地地址的优先时间和有效时间时无限的，永不超时。

## RA信息中的M、O

1. M=0，O=0：默认，仅使用SLAAC（仅使用该RA）；
2. M=0，O=1：无状态DHCP：SLAAC和DHCPv6（使用RA和DHCPv6服务器）；
3. M=1，不含O：有状态DHCPv6：使用DHCPv6服务器；

## 前缀重新编址中的2个地址

- 在转换期间，节点有两个单播地址使用：
  - 旧的地址：基于旧的前缀，用以维持以前已经建立的连接；
  - 新的地址：基于新的前缀，用来建立新的连接。
- **当旧的前缀的有效时间递减为0时**，旧的前缀完全废止，此时，RA中只包含新的前缀。

## 小结：无状态地址自动配置过程

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\SLAAC_process.png)

## DHCPv6的一般特点

- 使用UDP交换报文，端口**546/547**；（v4：67/68）
- 使用**本地链路地址**或其它机制获得的地址来发送和接收DHCPv6报文；
- 没有广播，客户机只需要发送给链路范围组播地址（FF02::1:2）；
- 取消了DHCPv4中的Discover和Offer消息。

## 有SLAAC为何需要DHCPv6

- 需要**动态指定DNS服务时**；
- 当**不希望MAC地址成为IPv6地址的一部分时**；
- 当需要良药的扩展性时。

## DHCP工作原理

1. DHCP客户发送请求广播；
2. DHCP服务器单播应答；
3. DHCP客户接收应答，获取IP等信息。

## DHCPv6获取地址和参数的典型过程

四步：

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\DHCP_process.png)

## DHCPv6的快速地址配置

若客户端已经记录了地址和其它配置信息，只需要DNS server、NTP server等信息：

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\DHCPv6_fast_address_configure.png)

## DHCPv6的重配置机制

服务器发起的（也需要DAD）：

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\DHCPv6_reconfigure.png)

# IPv6报文

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\ipv4_ipv6_PDU.png)

IPv6扩展包头：IPv6将一些IP层的可选功能实现在上层封装和IPv6基本头部之后的扩展头部中。

主要的扩展报头：逐跳选项、路由报头、分段报头、认证报头、封装安全有效载荷报头、目标选项。

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\ipv6_PDU_details.png)

**报头变化小结**：

修正项：

- 地址：32位 -> 128位；
- 生存时间 -> 跳数限制；
- 协议 -> 下一个头；
- 服务类型 -> 业务等级。

删掉的项

- 分段偏移量
- 标志、标识符
- 报头校验和
- 报头长
- 数据总长度

增加的项：流标识

IPv6的报头比IPv4的报头大小大2倍。

## IPv6扩展报头

逐条选择报头、目标选项报头、路由报头、片段报头、身份验证报头、封装安全有效载荷报头、目标选项报头

## ICMPv4与ICMPv6

ICMPv6保留了ICMPv4的常用功能：回声请求、抑制信息、重定向、参数错误（ping、traceroute）；

还进行了很大的扩展（ARP、IGMP）：邻居发现、无状态地址配置、路径MTU发现（PMTU）；

## ICMPv6报文类型

- 差错报文：通告IPv6分组传输过程中的错误
  - 目标不可达、数据包超长、超时、参数问题；
- 信息报文：提供诊断和附加的主机功能
  - MLD
  - ND（ARP，redirect）
  - 回声请求和应答

## ICMPv6报文格式

差错报文：Type=0xxxxxxx=0~127

信息报文：Type=1xxxxxxx=128~255

## ICMPv6的三个应用

1. ping
2. tracert
3. PMTU发现

## 源和目的在同一链路的数据转发

- 类似于IPv4同一网段的数据路由
- 通过地址前缀判断是否同一链路：on-link
- 发起地址解析（不同于v4的ARP）
- 由ND协议完成

## ND协议

![avatar](D:\Sunny\Documents\Notebook\Study\高级计算机网络\photos\ND.png)

## IPv6地址解析

意义：当两台主机需要直接通信时（链路层），需要根据目的主机的IP地址转为其对应的MAC地址，才能直接通信。

1. 先查找邻居缓存表，没有则进行地址解析；
2. 源主机发送**组播NS**报文，该报文的**目的地址**为**目标IPv6地址**所对应的被请求节点组播地址，在其中也包含了自己的链路层地址。
3. 目标主机收到NS报文后，就会了解到发送主机的IPv6地址和相应的链路层地址。
4. 目标主机向源主机单播发一个邻接点公告报文（**NA**），该报文中包含了自己的链路层地址。

## 源和目的不在同一链路的数据路由

解决两个问题：

- 主机发给哪个路由器？（主机-路由器）
  - PC1要和PC2通信：一个合法的IPv6地址
  - 一条包含PC2，下一跳RT1的路由
  - 重定向：优化主机-路由器之间的路由

- 路由器发给哪个路由器？（路由器-路由器）
  - 核心：路由表和静态路由

## Destination Cache目的缓存表

IPv6独有的数据结构。初始时为空。

某个地址在表中查不到时，改查路由表，做on-link判断：

- on-link：将目的地址加入DC表的nexthop域；
- off-link：将路由表中的下一跳加入DC表的nexthop域。

## IPv6下的动态路由协议

- 内部网关协议
  - DV：RIPng
  - LS：OSPFv3
- 边界网关协议
  - BGP4+