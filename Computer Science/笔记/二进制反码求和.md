# 二进制反码求和

IP/TCP/UDP均需要求校验和，校验和使用的是二进制反码校验：

假设原始数据为 1100 ， 1010 ， 0000（校验位）。 

那么把他们按照4bit一组进行按位取反相加。 1100 取反0011 ， 1010 取反是0101，校验位的计算就是 0011加上0101 是1000，填入到校验位上。

于是发送的数据就是：

1100, 1010, 1000 
收到数据后同样进行按位取反相加。

0011+0101+0111 =1111；全为1表示正确 。 

等于是自己加上自己的取反， 那么结果肯定应该是全1 。如果传输正确的话。

1. IP校验和：
    IP数据报的校验和只检验IP数据报的首部。
2. UDP校验和：
    UDP数据报计算校验和的方法和IP数据报校验和的方法相似，但是UDP的校验和是将首部和数据部分一起都校验。

    并且在计算UDP校验和之前需要封装一个伪首部，伪首部结构如下：

    源IP地址 | 目的IP地址 | 全 0 | 协 议 | UDP长度

3. TCP校验和：
    TCP 的校验和计算方法同UDP一样，同样要加上一个伪头部，区别是伪头部的协议码是0x06，长度是整个TCP报文的长度（包含TCP头部）。
4. ICMP校验和：
    ICMP校验和的计算方法一样，只不过只是对ICMP包整个进行校验和，没有伪头部，也不包括IP包头部。

总结如下： 计算IP数据报和ICMP的校验和时不需要封装伪首部，他俩不同的是IP数据报只检验IP数据报的首部，而ICMP数据报校验包括ICMP头部和数据部分（整个ICMP长度），TCP和UDP的校验方法和IP、ICMP校验方法一样，但是TCP和UDP校验之前需要封装伪首部。还有一个需要注意的是校验的顺序是从上（层）到下（层），如校验ICMP时，先校验ICMP后校验IP（ICMP数据包结构=ether + IP + ICMP）, 并且校验之前需要先将校验和的值初始化为0。