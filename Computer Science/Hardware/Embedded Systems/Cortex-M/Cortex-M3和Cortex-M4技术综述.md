# Cortex-M3和Cortex-M4技术综述

## Cortex-M3和Cortex-M4处理器的一般信息

### 处理器类型

ARM Cortex-M位32位RISC处理器，具有32位寄存器、内部数据通路以及总线接口。除了32位数据，Cortex-M处理器还可以高效处理16位和8位数据。Cortex-M3和Cortex-M4处理器还支持设计64位数据的多种运算。

Cortex-M3和Cortex-M4处理器都具有3级流水线（取指、译码、执行），且基于哈佛结构，取指令和数据访问可以同时进行。

ARM Cortex-M处理器的存储器系统使用32位寻址，地址空间最大为4GB。Cortex-M处理器基于一种加载——存储架构，数据需要从存储器中加载和处理后，使用多个单独的指令写回存储器。

### 处理器架构

对于ARM处理器，架构一般指两个方面：

- 架构。指令集架构（ISA）、编程模型（对软件可见）以及调试方法（对调试器可见）。
- 微架构。接口信号、指令执行时序以及流水线阶段等实现相关的细节。

Cortex-M3和Cortex-M4所使用的ARMv7架构可以在ARM网站上下载得到资料，这里将不再赘述。

### 指令集

Cortex-M处理器使用的指令集名为Thumb（包括16位以及32位Thumb指令），Cortex-M3和Cortex-M4处理器用到了Thumb-2技术，它允许16位和32位指令混合使用，以获取更高的代码密度和效率。

经典的ARM处理器如ARM7TDMI具有两种操作状态：32位的ARM状态和16位的Thumb状态。在ARM状态中，指令是32位的，内核能够以很高的指令性能执行所有支持的指令；对于Thumb状态，指令时16位的，这样可以得到很好的代码密度，不过Thumb指令不具有所有ARM指令的功能。要获得最好的性能，很多经典的ARM处理器应用程序混合了ARM和Thumb指令，导致了两者互相切换所带来的开销。

Thumb-2技术通过将Thumb指令集扩展位支持16位和32位两种解码方式，而无需再两个不同操作状态间切换就可以满足所有的处理请求。

事实上，Cortex-M处理器不支持32位ARM指令，而完全使用16位和32位的Thumb指令集。

Cortex-M3和Cortex-M4支持的指令组有：

- 16位ARMv6-M指令。
- 32位间接跳转链接指令。
- 32位系统指令。
- 16位ARMv7-M指令。
- 32位ARMv7-M指令。

而Cortex-M4还支持DSP扩展指令。如果Cortex-M4还具有FPU，则还支持浮点指令。

### 模块

Cortex-M3和Cortex-M4处理器包含处理器内核、嵌套向量中断控制器（NVIC）、Systick定时器以及可选的浮点单元（Cortex-M4）。此外还有一些内部总线系统、可选的存储器保护单元（MPU）以及支持软件调试操作的一组部件。

此外，下面列出Cortex-M3和Cortex-M4处理器上的各种总线接口有I-CODE（用于取指和取向量）、D-CODE（用于数据和调试器的访问操作）、系统、PPB（外部私有外设总线）以及DAP（调试访问端口）接口。

### 存储器系统

Cortex-M3和Cortex-M4处理器本身不包含任何存储器（没有程序存储器、SRAM或者缓存），它们具有通用的片上总线接口，而微控制器供应商则将它们自己的存储器系统添加到系统中，一般来说有：

- 程序存储器，一般是Flash。
- 数据存储器，一般是SRAM。
- 外设。

Cortex-M处理器的总线接口为32位宽，且基于高级微控制器总线架构（AMBA）标准。AMBA中包含多个总线协议。Cortex-M3和Cortex-M4处理器主要使用AHB Lite（高级高性能总线）总线接口协议，是流水线结构的总线协议，可以在低硬件成本下实现高运行频率。AHB Lite协议用于程序存储器和系统总线接口。

### 中断和异常支持

Cortex-M3和Cortex-M4处理器中存在NVIC，它是可编程的且其寄存器经过了存储器映射。NVIC的地址固定，而且NVIC的编程模型对于所有的Cortex-M处理器是一致的。除了外设和其它外部输入的中断外，NVIC还支持多个系统异常，其中，包括不可屏蔽中断（NMI）和处理器内部的其它异常源。

## Cortex-M3和Cortex-M4处理器的特性

### 性能

Cortex-M处理器架构为微控制器产品带来了高性能：

1. 三级流水线结构使得包括乘法在内的多数指令，可以在单周期内执行，同时允许微控制器设备运行较高的频率。
2. 由于多总线接口，指令和数据访问可以同时进行。
3. 流水线结构的总线接口使得存储器系统可以运行较高的时钟频率。
4. 指令集非常高效，执行复杂运算时可以使用较少的指令。
5. 每次取指都是32位的，而大多数指令都是16位的，因此一次可以取两条指令，带来了更高的性能和更佳的能耗效率。

### 存储器系统

Cortex-M3/M4处理器支持多种存储器特性：

1. 可寻址空间总共为4GB，且以32位寻址，无需将存储器分页。
2. 所有Cortex-M处理器的存储器映射定义都是一致的，预定义的存储器映射使得处理器设计可以为哈佛总线架构进行优化，而且访问处理器内经过存储器映射的外设（如NVIC）也非常容易。
3. 流水线结构的AHB Lite总线接口可以提供高速且低等待的传输。
4. 可选的位段特性。SRAM和外设空间中存在两个可位寻址的区域。
5. 支持大端以及小端的存储器系统。多数Cortex-M3微控制器产品使用小端。
6. 可选的MPU。

### 存储器保护单元

MPU在Cortex-M3/M4上是可选的。MPU一般通过软件（嵌入式OS）来进行配置，若MPU存在，应用程序可以将存储器空间分为多个部分，并为每个部分定义访问权限。当违反访问规则时，错误异常就会发生，错误异常分析则会分析问题。

MPU可以有多种使用方式，一般情况下，OS会设置MPU以保护OS内核和其他特权任务使用的数据，防止恶意用户程序的破坏。OS也可以将不同用户任务使用的存储器隔离开来。

### 中断处理

Cortex-M3/M4中存在一个复杂的中断控制器NVIC，其被称作嵌套向量中断控制器（NVIC）。NVIC具有多个特性：

1. 最多支持240个中断输入、不可屏蔽中断（NMI）输入和系统异常。每个中断都可以被单独使能或禁止。
2. 中断和多个系统异常具有可编程的优先级。对于Cortex-M3和Cortex-M4，优先级可以在运行时动态修改。
3. 嵌套中断/异常以及中断/异常按照优先级自动处理。
4. 向量中断/异常。处理器自动取出中断/异常向量，无需软件确定产生的是哪个中断/向量。
5. 中断和多个异常可以由软件触发。
6. 中断/异常屏蔽功能可以将所有的中断和异常（NMI除外）屏蔽掉，或者将中断/异常屏蔽为某个优先级之下。

NVIC使用了多个可编程的寄存器，这些寄存器经过了存储器映射。

向量表为系统存储器的一部分，其中存有中断和系统异常的起始地址。向量表默认位于存储器空间的开头，若需要也可以在运行时变为其他值。对于大多数应用程序，向量表可以在编译时被设置为应用程序影响的一部分，且在运行时保持不变。

### OS支持和系统级特性

Cortex-M3/M4具有一个系统内置的系统节拍定时器SysTick，可以为OS定时提供周期性定时中断。
